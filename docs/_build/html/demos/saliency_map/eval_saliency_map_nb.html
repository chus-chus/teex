<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evaluation of explanation quality: saliency maps &mdash; teex 1.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Decision rule" href="../decision_rule/decision_rule.html" />
    <link rel="prev" title="Generating image data with g.t. saliency maps" href="gen_saliency_map_nb.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> teex
            <img src="../../_static/rsz_teex_logo__.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Notebook demos</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="saliency_map.html">Saliency map</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="gen_saliency_map_nb.html">Generating image data with g.t. saliency maps</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Evaluation of explanation quality: saliency maps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#1.-Evaluating-synthetic-image-data-explanations">1. Evaluating synthetic image data explanations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#2.-Evaluating-Kahikatea-image-explanations">2. Evaluating Kahikatea image explanations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../decision_rule/decision_rule.html">Decision rule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../feature_importance/feature_importance.html">Feature importance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../word_importance/word_importance.html">Word importance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../model_selection/model_selection.html">Model selection</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">teex</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../examples.html">Notebook demos</a> &raquo;</li>
          <li><a href="saliency_map.html">Saliency map</a> &raquo;</li>
      <li>Evaluation of explanation quality: saliency maps</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/demos/saliency_map/eval_saliency_map_nb.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Evaluation-of-explanation-quality:-saliency-maps">
<h1>Evaluation of explanation quality: saliency maps<a class="headerlink" href="#Evaluation-of-explanation-quality:-saliency-maps" title="Permalink to this heading"></a></h1>
<p>In this notebook, we are going to explore how we can use <strong>teex</strong> to compare image explanation methods.</p>
<section id="1.-Evaluating-synthetic-image-data-explanations">
<h2>1. Evaluating synthetic image data explanations<a class="headerlink" href="#1.-Evaluating-synthetic-image-data-explanations" title="Permalink to this heading"></a></h2>
<p>In this section, we are going to 1. Generate image data with available g.t. explanations using the ‘seneca’ method. 2. Create and train a pytorch classifier that will learn to recognize the pattern in the images. 3. Generate explanations with some model agnostic methods and evaluate them w.r.t. the ground truth explanations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pip</span> install teex
<span class="o">%</span><span class="k">pip</span> install captum
<span class="o">%</span><span class="k">pip</span> install torch==1.7.1+cu110 torchvision==0.8.2+cu110 -f https://download.pytorch.org/whl/torch_stable.html
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span>

<span class="kn">from</span> <span class="nn">captum.attr</span> <span class="kn">import</span> <span class="n">GradientShap</span><span class="p">,</span> <span class="n">IntegratedGradients</span><span class="p">,</span> <span class="n">Occlusion</span><span class="p">,</span> <span class="n">DeepLift</span><span class="p">,</span> <span class="n">Lime</span><span class="p">,</span> <span class="n">GuidedBackprop</span><span class="p">,</span> <span class="n">GuidedGradCam</span>

<span class="kn">from</span> <span class="nn">teex.saliencyMap.data</span> <span class="kn">import</span> <span class="n">SenecaSM</span>
<span class="kn">from</span> <span class="nn">teex.saliencyMap.eval</span> <span class="kn">import</span> <span class="n">saliency_map_scores</span>

<span class="kn">from</span> <span class="nn">teex._utils._arrays</span> <span class="kn">import</span> <span class="n">_minmax_normalize_array</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
<span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/drive&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Mounted at /content/drive
</pre></div></div>
</div>
<section id="1.1.-Generating-the-data">
<h3>1.1. Generating the data<a class="headerlink" href="#1.1.-Generating-the-data" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cellH</span><span class="p">,</span> <span class="n">cellW</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
<span class="n">imH</span><span class="p">,</span> <span class="n">imW</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span>

<span class="n">generator</span> <span class="o">=</span> <span class="n">SenecaSM</span><span class="p">(</span><span class="n">imageH</span><span class="o">=</span><span class="n">imH</span><span class="p">,</span> <span class="n">imageW</span><span class="o">=</span><span class="n">imW</span><span class="p">,</span>
                     <span class="n">cellH</span><span class="o">=</span><span class="n">cellH</span><span class="p">,</span> <span class="n">cellW</span><span class="o">=</span><span class="n">cellW</span><span class="p">,</span>
                     <span class="n">nSamples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">randomState</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">exps</span> <span class="o">=</span> <span class="n">generator</span><span class="p">[:]</span>
<span class="n">pattern</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">pattern</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pattern&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Generated image&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">exps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Explanation&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Explanation&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_saliency_map_eval_saliency_map_nb_8_1.png" src="../../_images/demos_saliency_map_eval_saliency_map_nb_8_1.png" />
</div>
</div>
</section>
<section id="1.2.-Declaring-and-training-the-model">
<h3>1.2. Declaring and training the model<a class="headerlink" href="#1.2.-Declaring-and-training-the-model" title="Permalink to this heading"></a></h3>
<p>Declare a simple LeNet variant and its training routine.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FCNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Basic NN for image classification. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imH</span><span class="p">,</span> <span class="n">imW</span><span class="p">,</span> <span class="n">cellH</span><span class="p">,</span> <span class="n">randomState</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FCNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">kSize</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">randomState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kSize</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W1</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(((</span><span class="n">imH</span> <span class="o">-</span> <span class="n">kSize</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">floor</span><span class="p">(((</span><span class="n">imW</span> <span class="o">-</span> <span class="n">kSize</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kSize</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W2</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">H1</span> <span class="o">-</span> <span class="n">kSize</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">floor</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">W1</span> <span class="o">-</span> <span class="n">kSize</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kSize</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W3</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">H2</span> <span class="o">-</span> <span class="n">kSize</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">floor</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">W2</span> <span class="o">-</span> <span class="n">kSize</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">W3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># single instance, add the batch dimension</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="c1"># sample training function for classification</span>
<span class="k">def</span> <span class="nf">train_net</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">batchSize</span><span class="p">,</span> <span class="n">nEpochs</span><span class="p">,</span> <span class="n">randomState</span><span class="o">=</span><span class="mi">888</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; data: dict with &#39;train&#39; and &#39;val&#39; entries. Each entry is a list with X: FloatTensor, y: LongTensor &quot;&quot;&quot;</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">randomState</span><span class="p">)</span>
    <span class="n">bestValAcc</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">bestModelWeights</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nEpochs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

            <span class="n">lossVal</span> <span class="o">=</span> <span class="mf">.0</span>
            <span class="n">corrects</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">batchSize</span><span class="p">)):</span>
                <span class="n">XBatch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">batch</span><span class="p">:</span><span class="n">batch</span> <span class="o">+</span> <span class="n">batchSize</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">yBatch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">batch</span><span class="p">:</span><span class="n">batch</span> <span class="o">+</span> <span class="n">batchSize</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

                <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">):</span>

                    <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">XBatch</span><span class="p">)</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">yBatch</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
                        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                    <span class="n">_</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">lossVal</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">XBatch</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">corrects</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">preds</span> <span class="o">==</span> <span class="n">yBatch</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="n">epochLoss</span> <span class="o">=</span> <span class="n">lossVal</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">epochAcc</span> <span class="o">=</span> <span class="n">corrects</span><span class="o">.</span><span class="n">double</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s1"> Loss: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">epochLoss</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s1"> Acc: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">epochAcc</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;val&#39;</span> <span class="ow">and</span> <span class="n">epochAcc</span> <span class="o">&gt;</span> <span class="n">bestValAcc</span><span class="p">:</span>
                <span class="n">bestValAcc</span> <span class="o">=</span> <span class="n">epochAcc</span>
                <span class="n">bestModelWeights</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>

        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">bestModelWeights</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">bestValAcc</span>
</pre></div>
</div>
</div>
<p>We cast the images to torch.Tensor type and get train, validation and test splits.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">XTrain</span><span class="p">,</span> <span class="n">XTest</span><span class="p">,</span> <span class="n">yTrain</span><span class="p">,</span> <span class="n">yTest</span><span class="p">,</span> <span class="n">expsTrain</span><span class="p">,</span> <span class="n">expsTest</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">exps</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">XTrain</span><span class="p">,</span> <span class="n">XVal</span><span class="p">,</span> <span class="n">yTrain</span><span class="p">,</span> <span class="n">yVal</span><span class="p">,</span> <span class="n">expsTrain</span><span class="p">,</span> <span class="n">expsVal</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">XTrain</span><span class="p">,</span> <span class="n">yTrain</span><span class="p">,</span> <span class="n">expsTrain</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="n">XTrain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">XTrain</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">yTrain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">yTrain</span><span class="p">)</span>
<span class="n">XVal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">XVal</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">yVal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">yVal</span><span class="p">)</span>
<span class="n">XTest</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">XTest</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">yTest</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">yTest</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data proportions -&gt; Train: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">XTrain</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">, Val: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">XVal</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">, Test: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">XTest</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Positive label proportions -&gt; Train: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">yTrain</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">yTrain</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="se">\</span>
<span class="s1">Val: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">yVal</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">yVal</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">, Test: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">yTest</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">yTest</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Data proportions -&gt; Train: 0.6, Val: 0.2, Test: 0.2
Positive label proportions -&gt; Train: 0.489, Val: 0.526, Test: 0.507
</pre></div></div>
</div>
<p>and train the network</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nFeatures</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">XTrain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">FCNN</span><span class="p">(</span><span class="n">imH</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">imW</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">cellH</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">XTrain</span><span class="p">,</span> <span class="n">yTrain</span><span class="p">],</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">XVal</span><span class="p">,</span> <span class="n">yVal</span><span class="p">]}</span>

<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">XTrain</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">yTrain</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)]</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">XVal</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">yVal</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="n">model</span><span class="p">,</span> <span class="n">valAcc</span> <span class="o">=</span> <span class="n">train_net</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">batchSize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">nEpochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">randomState</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation F1: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">yVal</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">XVal</span><span class="o">.</span><span class="n">cuda</span><span class="p">()),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test F1: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">yTest</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">XTest</span><span class="o">.</span><span class="n">cuda</span><span class="p">()),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation F1: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">yVal</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">XVal</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test F1: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">yTest</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">XTest</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation F1: 0.988
Test F1: 0.983
</pre></div></div>
</div>
</section>
<section id="1.3.-Generating-and-evaluating-explanations">
<h3>1.3. Generating and evaluating explanations<a class="headerlink" href="#1.3.-Generating-and-evaluating-explanations" title="Permalink to this heading"></a></h3>
<p>With the model trained on the synthetic images, we generate explanations (with Captum, but feel free to use other methods!). First, declare the explainers:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layer</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_modules</span><span class="p">()][</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

<span class="n">gradShap</span> <span class="o">=</span> <span class="n">GradientShap</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">intGrad</span> <span class="o">=</span> <span class="n">IntegratedGradients</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">occlusion</span> <span class="o">=</span> <span class="n">Occlusion</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">deepLift</span> <span class="o">=</span> <span class="n">DeepLift</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">guidedBackProp</span> <span class="o">=</span> <span class="n">GuidedBackprop</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">guidedGradCAM</span> <span class="o">=</span> <span class="n">GuidedGradCam</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>And define a function to obtain the explanations from different methods:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_attributions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">explainer</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param data: (Tensor) data to explain</span>
<span class="sd">    :param targets: (Tensor) class labels w.r.t which we want to compute the attributions</span>
<span class="sd">    :param explainer: (captum.attr method) initialised explainer</span>
<span class="sd">    :param params: (dict) parameters for the .attribute method of the explainer</span>
<span class="sd">    :return: ndarray of shape with attributions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="s2">&quot;baselines&quot;</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;baselines&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;baselines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;baselines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">attributions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="c1"># mean pool channel attributions</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># viz._normalize_image_attr(tmp, &#39;absolute_value&#39;, 10)</span>
        <span class="n">attributions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_minmax_normalize_array</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">attributions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use predicted labels</span>
<span class="n">obsToExplain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">XTest</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">expsToCompare</span> <span class="o">=</span> <span class="n">expsTest</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="n">predTargets</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">predTargets</span><span class="p">])</span>
<span class="c1"># z = torch.zeros(len(predTargets), dtype=torch.int)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># takes some minutes to run</span>
<span class="n">gradShapExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">gradShap</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;baselines&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imH</span><span class="p">,</span> <span class="n">imW</span><span class="p">))})</span>
<span class="n">intGradExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">intGrad</span><span class="p">)</span>
<span class="n">deepLiftExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">deepLift</span><span class="p">)</span>
<span class="n">occlusionExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">occlusion</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;baselines&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;sliding_window_shapes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">cellH</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">cellW</span><span class="o">*</span><span class="mi">2</span><span class="p">)})</span>
<span class="n">gBackPropExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">guidedBackProp</span><span class="p">)</span>
<span class="n">gGradCAMExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">guidedGradCAM</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;expsSynth.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">gradShapExpsTest</span><span class="p">,</span> <span class="n">intGradExpsTest</span><span class="p">,</span> <span class="n">deepLiftExpsTest</span><span class="p">,</span> <span class="n">occlusionExpsTest</span><span class="p">,</span> <span class="n">gBackPropExpsTest</span><span class="p">,</span> <span class="n">gGradCAMExpsTest</span><span class="p">],</span> <span class="n">handle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;expsSynth.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
    <span class="n">gradShapExpsTest</span><span class="p">,</span> <span class="n">intGradExpsTest</span><span class="p">,</span> <span class="n">deepLiftExpsTest</span><span class="p">,</span> <span class="n">occlusionExpsTest</span><span class="p">,</span>\
        <span class="n">gBackPropExpsTest</span><span class="p">,</span> <span class="n">gGradCAMExpsTest</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Image&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">expsToCompare</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;g.t. explanation&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">intGradExpsTest</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;integratedGradient&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gradShapExpsTest</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;gradientSHAP&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">deepLiftExpsTest</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;deepLift&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">occlusionExpsTest</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;occlusion&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gBackPropExpsTest</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Guided Backprop.&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gGradCAMExpsTest</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Guided gradCAM.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Guided gradCAM.&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_saliency_map_eval_saliency_map_nb_26_1.png" src="../../_images/demos_saliency_map_eval_saliency_map_nb_26_1.png" />
</div>
</div>
<p>And we can evaluate the explanations. We set the binarization threshold for the generated explanations to 0.5 because we only want high values to count.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">,</span> <span class="s1">&#39;fscore&#39;</span><span class="p">,</span> <span class="s1">&#39;prec&#39;</span><span class="p">,</span> <span class="s1">&#39;rec&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">]</span>
<span class="n">gradShapScores</span> <span class="o">=</span> <span class="n">saliency_map_scores</span><span class="p">(</span><span class="n">expsTest</span><span class="p">[</span><span class="n">yTest</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">gradShapExpsTest</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">binThreshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">intGradScores</span> <span class="o">=</span> <span class="n">saliency_map_scores</span><span class="p">(</span><span class="n">expsTest</span><span class="p">[</span><span class="n">yTest</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">intGradExpsTest</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">binThreshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">deepLiftScores</span> <span class="o">=</span> <span class="n">saliency_map_scores</span><span class="p">(</span><span class="n">expsTest</span><span class="p">[</span><span class="n">yTest</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">deepLiftExpsTest</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">binThreshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">occlusionScores</span> <span class="o">=</span> <span class="n">saliency_map_scores</span><span class="p">(</span><span class="n">expsTest</span><span class="p">[</span><span class="n">yTest</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">occlusionExpsTest</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">binThreshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">gBackPropScores</span> <span class="o">=</span> <span class="n">saliency_map_scores</span><span class="p">(</span><span class="n">expsTest</span><span class="p">[</span><span class="n">yTest</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">gBackPropExpsTest</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">binThreshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">gGradCAMScores</span> <span class="o">=</span> <span class="n">saliency_map_scores</span><span class="p">(</span><span class="n">expsTest</span><span class="p">[</span><span class="n">yTest</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">gGradCAMExpsTest</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">binThreshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">gradShapScores</span><span class="p">,</span> <span class="n">intGradScores</span><span class="p">,</span> <span class="n">deepLiftScores</span><span class="p">,</span>
                            <span class="n">occlusionScores</span><span class="p">,</span> <span class="n">gBackPropScores</span><span class="p">,</span> <span class="n">gGradCAMScores</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
<span class="n">scores</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gradSHAP&#39;</span><span class="p">,</span> <span class="s1">&#39;intGrad&#39;</span><span class="p">,</span> <span class="s1">&#39;deepLift&#39;</span><span class="p">,</span> <span class="s1">&#39;occlusion&#39;</span><span class="p">,</span> <span class="s1">&#39;guidedBackProp&#39;</span><span class="p">,</span> <span class="s1">&#39;guidedGradCAM&#39;</span><span class="p">]</span>
<span class="n">scores</span>
</pre></div>
</div>
</div>
<p>Note how the warnings tell us that the predictions from one of the techniques did not contain any relevant values.</p>
<p>From here, we can build a more complex explanation evaluation pipeline. Suppose that, given some explainer architecture and model, we want to measure how the influence of some explainer hyperparameters influence the quality of their generated explanations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_explainers</span><span class="p">(</span>
        <span class="n">explainers</span><span class="p">,</span>
        <span class="n">explainerConfigs</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">targets</span><span class="p">,</span>
        <span class="n">trueExps</span><span class="p">,</span>
        <span class="n">metrics</span><span class="p">,</span>
        <span class="n">binThreshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param explainers: (dict of captum.attr explainers) explainers to use</span>
<span class="sd">    :param explainerConfigs: (dict of list of dict) hyperparameter values to use for each explainer (see Captum docs)</span>
<span class="sd">    :param data: (Tensor) data to explain</span>
<span class="sd">    :param targets: (Tensor) labels w.r.t. which we compute the explanations</span>
<span class="sd">    :param trueExps: (ndarray) ground truth explanations</span>
<span class="sd">    :param metrics: (array-like of str) metrics to compute</span>
<span class="sd">    :param float binThreshold: threshold to use when binarizing for the computation of classification metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allScores</span> <span class="o">=</span> <span class="p">{</span><span class="n">explainer</span><span class="p">:</span> <span class="p">{</span><span class="n">met</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">}</span> <span class="k">for</span> <span class="n">explainer</span> <span class="ow">in</span> <span class="n">explainers</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">explainerName</span><span class="p">,</span> <span class="n">explainer</span> <span class="ow">in</span> <span class="n">explainers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">explainerConfigs</span><span class="p">[</span><span class="n">explainerName</span><span class="p">]:</span>
            <span class="n">exps</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">explainer</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
            <span class="n">evals</span> <span class="o">=</span> <span class="n">saliency_map_scores</span><span class="p">(</span><span class="n">trueExps</span><span class="p">,</span> <span class="n">exps</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">binThreshold</span><span class="o">=</span><span class="n">binThreshold</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evals</span><span class="p">):</span>
                <span class="n">allScores</span><span class="p">[</span><span class="n">explainerName</span><span class="p">][</span><span class="n">metrics</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">allScores</span>
</pre></div>
</div>
</div>
<p>for example, given these gradSHAP and guidedGradCAM configurations:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">configs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;gradSHAP&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;baselines&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imH</span><span class="p">,</span> <span class="n">imW</span><span class="p">)),</span> <span class="s1">&#39;n_samples&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;stdevs&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
                 <span class="p">{</span><span class="s1">&#39;baselines&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imH</span><span class="p">,</span> <span class="n">imW</span><span class="p">)),</span> <span class="s1">&#39;n_samples&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;stdevs&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">}],</span>
    <span class="s1">&#39;gradCAM&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;interpolate_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;nearest&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;interpolate_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;area&#39;</span><span class="p">}]</span>
<span class="p">}</span>

<span class="n">explainers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gradSHAP&#39;</span><span class="p">:</span> <span class="n">gradShap</span><span class="p">,</span> <span class="s1">&#39;gradCAM&#39;</span><span class="p">:</span> <span class="n">guidedGradCAM</span><span class="p">}</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">,</span> <span class="s1">&#39;fscore&#39;</span><span class="p">,</span> <span class="s1">&#39;prec&#39;</span><span class="p">,</span> <span class="s1">&#39;rec&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># takes some minutes to run</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">eval_explainers</span><span class="p">(</span><span class="n">explainers</span><span class="p">,</span> <span class="n">configs</span><span class="p">,</span> <span class="n">XTest</span><span class="p">[</span><span class="n">yTest</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">yTest</span><span class="p">[</span><span class="n">yTest</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="n">expsTest</span><span class="p">[</span><span class="n">yTest</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="n">metrics</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;synthScores.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;synthScores.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For each explainer and configuration, we have a score:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;gradSHAP&#39;: {&#39;auc&#39;: [0.7992577, 0.80201876],
  &#39;fscore&#39;: [0.5050217, 0.5090714],
  &#39;prec&#39;: [0.9954608, 0.9955106],
  &#39;rec&#39;: [0.34479782, 0.3487118],
  &#39;cs&#39;: [0.39023715, 0.3968119]},
 &#39;gradCAM&#39;: {&#39;auc&#39;: [0.34990147, 0.31682178],
  &#39;fscore&#39;: [0.1094004, 0.11006599],
  &#39;prec&#39;: [0.05815248, 0.058509283],
  &#39;rec&#39;: [0.9214127, 0.92628205],
  &#39;cs&#39;: [0.23264565, 0.23132235]}}
</pre></div></div>
</div>
<p>With these metrics, then, we can evaluate the performance of explainers.</p>
</section>
</section>
<section id="2.-Evaluating-Kahikatea-image-explanations">
<h2>2. Evaluating Kahikatea image explanations<a class="headerlink" href="#2.-Evaluating-Kahikatea-image-explanations" title="Permalink to this heading"></a></h2>
<p>teex includes real datasets with available ground truth explanations. For example, the Kahikatea dataset contains 519 images, and the task is to tell whether each observation contains Kahikatea trees or not. There are 232 positive observations and 287 negative ones.</p>
<p>In teex, the non-artificial datasets are implemented as classes, similarly to PyTorch. After instancing the class, the data itself will be downloaded if it has not been used before. Once done, one can slice it to obtain observations. Each observation contains the data point, the label and the ground truth explanation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">teex.saliencyMap.data</span> <span class="kn">import</span> <span class="n">Kahikatea</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nClasses</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">kahikateaData</span> <span class="o">=</span> <span class="n">Kahikatea</span><span class="p">()</span>
<span class="n">kData</span><span class="p">,</span> <span class="n">kLabels</span><span class="p">,</span> <span class="n">kExps</span> <span class="o">=</span> <span class="n">kahikateaData</span><span class="p">[:]</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Files do not exist or are corrupted:
Downloading https://zenodo.org/record/5059769/files/kahikatea.zip?download=1 to /opt/conda/lib/python3.7/site-packages/teex/_datasets/saliencyMap/kahikatea/rawKahikatea.zip
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
142303232it [00:43, 3241716.65it/s]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">kData</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Image&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">kExps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;g.t. explanation&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;g.t. explanation&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_saliency_map_eval_saliency_map_nb_42_1.png" src="../../_images/demos_saliency_map_eval_saliency_map_nb_42_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kahikateaData</span><span class="o">.</span><span class="n">classMap</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{0: &#39;Not in image&#39;, 1: &#39;In image&#39;}
</pre></div></div>
</div>
<p>Let’s fine-tune a pre-trained squeezenet for our particular task.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">_validate_not_a_forked_repo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">:</span> <span class="kc">True</span>  <span class="c1">#</span>
<span class="n">sqznet</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;pytorch/vision:v0.9.0&#39;</span><span class="p">,</span> <span class="s1">&#39;squeezenet1_0&#39;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Using cache found in /root/.cache/torch/hub/pytorch_vision_v0.9.0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;torch._C.Generator at 0x7fd90d5742b0&gt;
</pre></div></div>
</div>
<p>And modify its architecture so the shape of the output conforms to our 2-class problem instead of the 1000-class ImageNet.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sqznet</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">nClasses</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">sqznet</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">nClasses</span>
<span class="n">inputSize</span> <span class="o">=</span> <span class="mi">224</span>
</pre></div>
</div>
</div>
<p>Define the required transform for the input images</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>

<span class="n">inputTransform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">inputSize</span><span class="p">,</span> <span class="n">inputSize</span><span class="p">)),</span>
                                     <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                                     <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])])</span>
<span class="n">resizeTransform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">inputSize</span><span class="p">,</span> <span class="n">inputSize</span><span class="p">)),</span>
                                     <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span>
</pre></div>
</div>
</div>
<p>Transform the data to torch tensors and create the splits:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kData</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">inputTransform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">kData</span><span class="p">])</span>
<span class="n">kExps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">resizeTransform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">inputSize</span><span class="p">,</span> <span class="n">inputSize</span><span class="p">))</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">kExps</span><span class="p">])</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">kExps</span> <span class="o">=</span> <span class="n">kExps</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># we need g.t. explanations to be numpy arrays for the evaluation</span>
<span class="n">kLabels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">kLabels</span><span class="p">)</span>

<span class="n">kTrain</span><span class="p">,</span> <span class="n">kTest</span><span class="p">,</span> <span class="n">kTrainLabels</span><span class="p">,</span> <span class="n">kTestLabels</span><span class="p">,</span> <span class="n">kExpsTrain</span><span class="p">,</span> <span class="n">kExpsTest</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">kData</span><span class="p">,</span> <span class="n">kLabels</span><span class="p">,</span> <span class="n">kExps</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">kTrain</span><span class="p">,</span> <span class="n">kVal</span><span class="p">,</span> <span class="n">kTrainLabels</span><span class="p">,</span> <span class="n">kValLabels</span><span class="p">,</span> <span class="n">kExpsTrain</span><span class="p">,</span> <span class="n">kExpsVal</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">kTrain</span><span class="p">,</span> <span class="n">kTrainLabels</span><span class="p">,</span> <span class="n">kExpsTrain</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data proportions -&gt; Train: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kTrain</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">kData</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">, Val: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kVal</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">kData</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">, Test: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kTest</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">kData</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Positive label proportions -&gt; Train: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">kTrainLabels</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">kTrainLabels</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="se">\</span>
<span class="s1">Val: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">kValLabels</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">kValLabels</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">, Test: </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">kTestLabels</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">kTestLabels</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Data proportions -&gt; Train: 0.599, Val: 0.2, Test: 0.2
Positive label proportions -&gt; Train: 0.444, Val: 0.519, Test: 0.385
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opt</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">sqznet</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">crit</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">batchSize</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">nEpochs</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">kTrain</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">kTrainLabels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)],</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">kVal</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">kValLabels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)]}</span>

<span class="n">sqznet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">sqznet</span><span class="p">,</span> <span class="n">valAcc</span> <span class="o">=</span> <span class="n">train_net</span><span class="p">(</span><span class="n">sqznet</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">batchSize</span><span class="p">,</span> <span class="n">nEpochs</span><span class="p">,</span> <span class="n">randomState</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sqznetTrained.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sqznet</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sqznetTrained.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">sqznet</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation F1: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">kValLabels</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">sqznet</span><span class="p">(</span><span class="n">kVal</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test F1: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">kTestLabels</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">sqznet</span><span class="p">(</span><span class="n">kTest</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation F1: 0.816
Test F1: 0.643
</pre></div></div>
</div>
<p>Let us get some explanations as samples</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">back_hook</span> <span class="o">=</span> <span class="s1">&#39;register_full_backward_hook&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s1">&#39;1.8.0&#39;</span> <span class="k">else</span> <span class="s1">&#39;register_backward_hook&#39;</span>

<span class="n">gradShap</span> <span class="o">=</span> <span class="n">GradientShap</span><span class="p">(</span><span class="n">sqznet</span><span class="p">)</span>
<span class="n">intGrad</span> <span class="o">=</span> <span class="n">IntegratedGradients</span><span class="p">(</span><span class="n">sqznet</span><span class="p">)</span>
<span class="n">occlusion</span> <span class="o">=</span> <span class="n">Occlusion</span><span class="p">(</span><span class="n">sqznet</span><span class="p">)</span>
<span class="n">deepLift</span> <span class="o">=</span> <span class="n">DeepLift</span><span class="p">(</span><span class="n">sqznet</span><span class="p">)</span>
<span class="n">guidedBackProp</span> <span class="o">=</span> <span class="n">GuidedBackprop</span><span class="p">(</span><span class="n">sqznet</span><span class="p">)</span>
<span class="n">guidedGradCAM</span> <span class="o">=</span> <span class="n">GuidedGradCam</span><span class="p">(</span><span class="n">sqznet</span><span class="p">,</span> <span class="n">sqznet</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>

<span class="c1"># use predicted labels</span>
<span class="n">obsToExplain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">kTest</span><span class="p">[</span><span class="n">kTestLabels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">expsToCompare</span> <span class="o">=</span> <span class="n">kExpsTest</span><span class="p">[</span><span class="n">kTestLabels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">predTargets</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">sqznet</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># takes some minutes to run</span>
<span class="n">gradShapExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">gradShap</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;baselines&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">inputSize</span><span class="p">,</span> <span class="n">inputSize</span><span class="p">))})</span>
<span class="n">intGradExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">intGrad</span><span class="p">)</span>
<span class="n">deepLiftExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">deepLift</span><span class="p">)</span>
<span class="n">occlusionExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">occlusion</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;baselines&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;sliding_window_shapes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">inputSize</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">inputSize</span><span class="p">))})</span>
<span class="n">gBackPropExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">guidedBackProp</span><span class="p">)</span>
<span class="n">gGradCAMExpsTest</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">guidedGradCAM</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/conda/lib/python3.7/site-packages/captum/attr/_core/guided_backprop_deconvnet.py:65: UserWarning: Setting backward hooks on ReLU activations.The hooks will be removed after the attribution is finished
  &#34;Setting backward hooks on ReLU activations.&#34;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we binarize the results for easier visualization (this step is implicitly done by teex)</span>
<span class="c1">#   when computing metrics.</span>
<span class="kn">from</span> <span class="nn">teex._utils._arrays</span> <span class="kn">import</span> <span class="n">_binarize_arrays</span>

<span class="n">gsh</span> <span class="o">=</span> <span class="n">_binarize_arrays</span><span class="p">(</span><span class="n">gradShapExpsTest</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.55</span><span class="p">)</span>
<span class="n">ig</span> <span class="o">=</span> <span class="n">_binarize_arrays</span><span class="p">(</span><span class="n">intGradExpsTest</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.55</span><span class="p">)</span>
<span class="n">dl</span> <span class="o">=</span> <span class="n">_binarize_arrays</span><span class="p">(</span><span class="n">deepLiftExpsTest</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.55</span><span class="p">)</span>
<span class="n">oc</span> <span class="o">=</span> <span class="n">_binarize_arrays</span><span class="p">(</span><span class="n">occlusionExpsTest</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.55</span><span class="p">)</span>
<span class="n">gbp</span> <span class="o">=</span> <span class="n">_binarize_arrays</span><span class="p">(</span><span class="n">gBackPropExpsTest</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.55</span><span class="p">)</span>
<span class="n">ggc</span> <span class="o">=</span> <span class="n">_binarize_arrays</span><span class="p">(</span><span class="n">gGradCAMExpsTest</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.55</span><span class="p">)</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Image&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">expsToCompare</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;g.t. explanation&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;integratedGradient&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gsh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;gradientSHAP&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dl</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;deepLift&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">oc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;occlusion&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gbp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Guided Backprop.&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ggc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Guided gradCAM.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Guided gradCAM.&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/demos_saliency_map_eval_saliency_map_nb_58_1.png" src="../../_images/demos_saliency_map_eval_saliency_map_nb_58_1.png" />
</div>
</div>
<p>From this visualization, it is clear that the threshold level is an important hyperparameter to consider.</p>
<p>Now, let’s evaluate the quality of the explanations:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kExplainers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gradSHAP&#39;</span><span class="p">:</span> <span class="n">GradientShap</span><span class="p">(</span><span class="n">sqznet</span><span class="p">),</span>
               <span class="s1">&#39;gradCAM&#39;</span><span class="p">:</span> <span class="n">GuidedGradCam</span><span class="p">(</span><span class="n">sqznet</span><span class="p">,</span> <span class="n">sqznet</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">12</span><span class="p">]),</span>
               <span class="s1">&#39;deepLift&#39;</span><span class="p">:</span> <span class="n">DeepLift</span><span class="p">(</span><span class="n">sqznet</span><span class="p">),</span>
               <span class="s1">&#39;backProp&#39;</span><span class="p">:</span> <span class="n">GuidedBackprop</span><span class="p">(</span><span class="n">sqznet</span><span class="p">),</span>
               <span class="s1">&#39;occlusion&#39;</span><span class="p">:</span> <span class="n">Occlusion</span><span class="p">(</span><span class="n">sqznet</span><span class="p">),</span>
               <span class="s1">&#39;intGrad&#39;</span><span class="p">:</span> <span class="n">IntegratedGradients</span><span class="p">(</span><span class="n">sqznet</span><span class="p">)}</span>

<span class="n">kConfigs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;gradSHAP&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;baselines&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">inputSize</span><span class="p">,</span> <span class="n">inputSize</span><span class="p">)),</span> <span class="s1">&#39;n_samples&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;stdevs&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}],</span>
    <span class="s1">&#39;gradCAM&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;interpolate_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;nearest&#39;</span><span class="p">}],</span>
    <span class="s1">&#39;deepLift&#39;</span><span class="p">:</span> <span class="p">[{}],</span>
    <span class="s1">&#39;backProp&#39;</span><span class="p">:</span> <span class="p">[{}],</span>
    <span class="s1">&#39;occlusion&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;baselines&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;sliding_window_shapes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">inputSize</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">inputSize</span><span class="p">))}],</span>
    <span class="s1">&#39;intGrad&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;riemann_trapezoid&#39;</span><span class="p">}]</span>
<span class="p">}</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">,</span> <span class="s1">&#39;fscore&#39;</span><span class="p">,</span> <span class="s1">&#39;prec&#39;</span><span class="p">,</span> <span class="s1">&#39;rec&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">]</span>

<span class="n">binThresholds</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="o">/</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<p>Evaluate positive test explanations. Note that teex implicitly handles the conversion of the RGB masks into 0-1 normalised grayscale masks (the shape of the g.t.s need to be (imH, imW, 3) for it to happen).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use predicted labels</span>
<span class="n">obsToExplain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">kTest</span><span class="p">[</span><span class="n">kTestLabels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">expsToCompare</span> <span class="o">=</span> <span class="n">kExpsTest</span><span class="p">[</span><span class="n">kTestLabels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">predTargets</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">sqznet</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># comparison to ground truth explanations</span>
<span class="n">resGT</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">binThres</span> <span class="ow">in</span> <span class="n">binThresholds</span><span class="p">:</span>
    <span class="c1"># takes a few minutes to run</span>
    <span class="n">scoresK</span> <span class="o">=</span> <span class="n">eval_explainers</span><span class="p">(</span><span class="n">kExplainers</span><span class="p">,</span> <span class="n">kConfigs</span><span class="p">,</span> <span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span>
                              <span class="n">expsToCompare</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">binThreshold</span><span class="o">=</span><span class="n">binThres</span><span class="p">)</span>
    <span class="n">resGT</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">binThres</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scoresK</span>
    <span class="c1"># fileName = f&#39;kahikateaScoresThres{binThres}.pickle&#39;</span>
    <span class="c1"># with open(fileName, &#39;wb&#39;) as f:</span>
    <span class="c1">#     pickle.dump(scoresK, f)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;kahikateaScores&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">resGT</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resGT</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># comparison to integrated gradients explanations</span>
<span class="n">obsToExplain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">kTest</span><span class="p">[</span><span class="n">kTestLabels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">predTargets</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">sqznet</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">expsToCompare</span> <span class="o">=</span> <span class="n">get_attributions</span><span class="p">(</span><span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span> <span class="n">intGrad</span><span class="p">)</span>

<span class="n">resIntGrad</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">binThres</span> <span class="ow">in</span> <span class="n">binThresholds</span><span class="p">:</span>
    <span class="c1"># takes a few minutes to run</span>
    <span class="n">scoresK</span> <span class="o">=</span> <span class="n">eval_explainers</span><span class="p">(</span><span class="n">kExplainers</span><span class="p">,</span> <span class="n">kConfigs</span><span class="p">,</span> <span class="n">obsToExplain</span><span class="p">,</span> <span class="n">predTargets</span><span class="p">,</span>
                              <span class="n">expsToCompare</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">binThreshold</span><span class="o">=</span><span class="n">binThres</span><span class="p">)</span>
    <span class="n">resIntGrad</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">binThres</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scoresK</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;kahikateaScores&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">resIntGrad</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resIntGrad</span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="gen_saliency_map_nb.html" class="btn btn-neutral float-left" title="Generating image data with g.t. saliency maps" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../decision_rule/decision_rule.html" class="btn btn-neutral float-right" title="Decision rule" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Chus Antonanzas.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>